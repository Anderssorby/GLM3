---
title: "Logistic regression and Poisson regression"
author: "Anders Christiansen SÃ¸rby, Edvard Hove, Angela Maiken Johnsen"
date: "October 4, 2018"
output:
  pdf_document: default
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#install.packages("ggplot2")
#install.packages("GGally")
#install.packages("rlist")
#install.packages("lme4")
library(ggplot2)
library(rlist)
library(reshape2)
library(plyr)
library(GGally)

my_dens <- function(data, mapping, ...) {
  ggplot(data = data, mapping=mapping) +
    geom_density(..., alpha = 1, fill = NA) 
}

```


# a)
```{r}
dataset <- read.table("https://www.math.ntnu.no/emner/TMA4315/2018h/jsp2.txt", header = TRUE)
ggpairs(data = dataset, mapping = aes(col = gender, alpha=0.7), columns = c("social", "raven", "math"), legend = 1)
```
From the plot it can be seen from the top and bottom right panel that girls have higher average maths scores than boys. This is because the mean of the blue box plots in the top right panel (corresponding to the girls' maths scores) are higher than that of the boys' (red boxes). However, as 0 is included in all the box plots, the difference is not too big. The same conclusion can be drawn from the bottom right panel; here the distribution of the girls' maths scores have a peak slightly more to the right than that of the boys.  

The middle section shows that the gender differences are small for the raven tests. However mostly there are few differences between the different social class. 

Fitting a linear model with math as response and raven and gender as covariates:
```{r}
model = lm(math ~ raven + gender, data = dataset)
summary(model)
```
The model for the $k$th student is thus

$$
Y_k={\bf x}_k \pmb{\beta} + \varepsilon_k,
$$
where the $\varepsilon_k$s are independent, have mean 0 and variance $\sigma^2$. Here the $Y_k$ is the response, $\bf x_k$ are the covariates, $\varepsilon_k$ are the errors and $\pmb{\beta}$ the fixed effects parameters.
Here the parameter estimates are $\hat\beta_0 = -1.313$,  $\hat\beta_{\mathrm{raven}} = 0.1965$ and $\hat\beta_{\mathrm{gendergirl}} = 2.538$. This means that being a girl has a positive impact on the maths test score, and a positive raven test score also gives a positive impact on the maths test score. Here $\hat\beta_0$, i. e. the intercept, corresponds to the parameter estimate for a boy. 
By looking at the $p$ values of the parameter estimates, all of them are highly significant. 
In this model we are investigating if there is a linear relationship between maths test score and raven test score and gender, and we are assuming that the maths test score does not depend on social status and which school the student comes from.

# b)
Now a random intercept model with math as response and raven and gender as covariates as before, in addition to school as a random intercept. This can be written mathematically as

$$
{\bf Y}_{i} = {\bf X}_i\beta + {\bf 1} \gamma_{0i} + \varepsilon_{i}
$$
As before $\bf Y_i$ is the response, $\bf X_i$ the covariates, $\beta$ the fixed effects (and $\beta_0$ the fixed population intercept), $\gamma_{0i}$ the deviation (for members of cluster $i$) from the population intercept $\beta_0$.
The response, $\bf Y_i$, is a $n_i\times 1$ vector, where $n_i$ is the number of observations from cluster $i$.
Each student has its own row in the matrix $\bf X_i$.
Each row contains an intercept and 2 covariates, making it an $n_i \times 3$ matrix, and $\beta$ a $3 \times 1$ vector.
The vector ${\bf 1}$ is a $n_i\times 1$ vector consisting of only 1's, and realizations of the random variable $\gamma_{0i}$ are scalars.
Lastly $\varepsilon_{i}$ has the same dimensions as $Y_i$, that is $n_i\times 1$.
In our case this means the number of students from school $i$.
We assume that $\gamma_{0i} \sim \mathcal{N}(0,\tau_0^2)$ and $\varepsilon_{i} \sim \mathcal{N}_{n_i}(0,\sigma^2I)$.
It is also assumed that the $\gamma_{0i}$ are independent, and also independent from all the $\varepsilon_{i}$ vectors.
We also assume that the responses at school $i$ and $k$ are independent.

```{r}
library(lme4)
fitRI1 <- lmer(math ~ raven + gender + (1 | school), data = dataset)
summary(fitRI1)
```
The estimates for this model are more or less in agreement with those of the previous one.
Girls and those who do well on the raven test are still expected to do better on the math test.
The model predicts girls to score 2.511 points higher on the test than boys, and a student who scores 1 point higher on the raven test is predicted to score 0.214 points higher on the math test.
The new model estimates the effect from a good raven test to be slightly higher (0.214 vs 0.197), and the effect of gender to be slightly lower (2.511 vs 2.538).

The p-values are omitted from the printout because the common assumptions used to compute p-values does not hold in this model. There are no analytical results for the null distribution of parameter estimates in complex situations for mixed models. The null distribution is the distribution of the test statistic when the null hypothesis is true. In general the parameter estimates are not t-distributed for finite size samples though it holds asymptotically.

We can test the siginificance of the $\beta_{raven}$ parameter by doing a hypothesis test $H_0: \beta_{raven} = 0$ against $H_1:\beta_{raven} \neq 0$. This can be done with a Wald-test which in this case reduces to a Z-test. 
```{r }
pvalue <- 2*(1-pnorm(abs(9.197)))
pvalue
```
The t-value for raven is rather big so the following pvalue is very small. We are forced to reject the null hypothesis. 

Also we can compute a $(1-\alpha)\cdot100\% = 95\%$-confidence interval for the effect of female gender on math score. 
\begin{align*}
\text{CI}_{j} &= \left[\hat\beta_{j} - \Phi^{-1}(1-\alpha/2)\cdot \widehat{SD}(\hat\beta_{j}),\  \hat\beta_{j} + \Phi^{-1}(1-\alpha/2)\cdot \widehat{SD}(\hat\beta_{j}) \right] \\
&= [2.51119 - 1.96\cdot 0.26684 , 2.51119 + 1.96\cdot 0.26684  ] \\
&= [1.988184, 3.034196]
\end{align*}

# c)
# d)
# e)

